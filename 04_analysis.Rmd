---
title: "04_analysis"
author: "Adriana Uscanga"
date: "2/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load packages and data

```{r}
library(tidyverse)
library(ggplot2)
library(sf)
library(spdep)
library(leaps)

load("output/sites_cf3.RData")
load("output/plots_cf3.RData")
load("output/trees_cf3.RData")
```

Add slope and aspect to the data set.

```{r}
#Aspect and Slope from GEE 
aspect <- read_csv("C:/Users/adriana/Documents/OregonPhD/Tesis/ch1/aspect_and_slope/aspect_plots.csv", col_names = F)

slope <- read_csv("C:/Users/adriana/Documents/OregonPhD/Tesis/ch1/aspect_and_slope/slope_plots.csv", col_names = F)

head(aspect)

aspect <- aspect %>%
  transmute(plot_id = as.character(X5),
            lon = as.numeric(X3),
            lat = as.numeric(X4),
            aspect = as.numeric(X2))

head(aspect)

slope <- slope %>%
  transmute(plot_id = as.character(X5),
            lon = as.numeric(X3),
            lat = as.numeric(X4),
            slope = as.numeric(X2))
head(slope)

aspect_slope <- aspect %>%
  left_join(slope, by = c("plot_id", "lon", "lat"))

plots_cf <- plots_cf %>%
  left_join(aspect_slope, by = c("plot_id")) %>%
  select(-lon, -lat) %>%
  relocate(c(aspect, slope), .after = altitude)

plots_cf %>%
  filter(duplicated(longitude), duplicated(latitude)) %>%
  group_by(site) %>%
  summarize(sites = unique(site), plots = unique(plot_id))

plots_cf <- plots_cf %>%
  group_by(site) %>%
  summarize(plot_id = plot_id,
            aspect_first = first(aspect),
            dup = ifelse(duplicated(longitude) & duplicated(latitude), "duplicated", NA),
            aspectdups = ifelse(dup == "duplicated", aspect_first, NA),
            slope_first = first(slope),
            dup_s = ifelse(duplicated(longitude) & duplicated(latitude), "duplicated", NA),
            slopedups = ifelse(dup_s == "duplicated", slope_first, NA)) %>%
  filter(!is.na(dup)) %>%
  select(plot_id, aspectdups, slopedups) %>%
  right_join(plots_cf) %>%
  mutate(aspect = ifelse(is.na(aspect), aspectdups, aspect),
         slope = ifelse(is.na(slope), slopedups, slope)) %>%
  select(-aspectdups, -slopedups)

plots_cf %>%
  filter(is.na(aspect))
#Weird, plot 67878_2 doesn't have aspect and slope, it must have been missing from the GEE feature collection. I'll extract data for this plot and add it.
# aspect = 334.7877502441406
# slope= 34.21200942993164

plots_cf <- plots_cf %>%
  mutate(aspect = ifelse(plot_id == "67878_2", 334.787750, aspect),
         slope = ifelse(plot_id == "67878_2", 34.212009, slope))

# Average aspect and slope by site

calcSE<-function(x){
  x <- x[is.na(x)==F]
  sd(x)/sqrt(length(x))
}

aspect_slope_sites <- plots_cf %>%
  select(site, plot_id, aspect, slope) %>%
  group_by(site) %>%
  summarize(aspect_gee = mean(aspect),
            aspect_se_gee = calcSE(aspect),
            slope_gee = mean(slope),
            slope_se_gee = calcSE(slope)) %>%
  mutate(site = as.character(site))

sites_cf <- sites_cf %>%
  left_join(aspect_slope_sites, by = "site") %>%
  relocate(c("aspect_gee", "aspect_se_gee", "slope_gee", "slope_se_gee"), .after = aspect)
```


# Spatial autocorrelation

Examples: 
- https://www.spatialanalysisonline.com/An%20Introduction%20to%20Spatial%20Data%20Analysis%20in%20R.pdf
- https://gwenantell.com/exploring-spatial-autocorrelation-in-r/
- https://rpubs.com/quarcs-lab/spatial-autocorrelation
- Bart's class: https://pjbartlein.github.io/GeogDataAnalysis/lec13.html

Site 71213 in sites_cf data set lacks geographic coordinates.
Which are: 17.50506, -96.30769

```{r}
sites_cf <- sites_cf %>%
  mutate(longitude = ifelse(site == "71213", -96.30769, longitude),
         latitude = ifelse(site == "71213", 17.50506, latitude))
```

Get distance-neighbor matrix  and plot network of sites.

```{r}

#distance neighbors
loc <- cbind(sites_cf$longitude, sites_cf$latitude)
d <- 10 #distance has to be larger than the distance that exists between sites, which is 2.5 km
sites_neighbors_dist <- dnearneigh(loc, 0, d, longlat = T)
str(sites_neighbors_dist)
plot(sites_neighbors_dist, loc)

plot(loc)

```


Plot environmental variables to reveal the relationships and spatial patterns among them

```{r}

plot(sites_cf[-22,c(10:14,18,20,34)]) #remove site 70307 (outlier)
plot(sites_cf[-22,c(12,13,18,20,34,40,48)])
```

Moran test

```{r}
# spatial autocorrelation of dependent variable (AGB and Simpson)
moran.test(sites_cf$av_agb_site, zero.policy=T, 
     nb2listw(sites_neighbors_dist, zero.policy=T, style="W"))


```
*25km apart*:
	Moran I test under randomisation

data:  sites_cf$av_agb_site  
weights: nb2listw(sites_neighbors_dist, zero.policy = T, style = "W")    

Moran I statistic standard deviate = 3.2834, p-value =
0.0005128
alternative hypothesis: greater
sample estimates:
Moran I statistic       Expectation          Variance 
      0.106909344      -0.009433962       0.001255547
      

*20 km apart:*
Moran I test under randomisation

data:  sites_cf$av_agb_site  
weights: nb2listw(sites_neighbors_dist, zero.policy = T, style = "W")    

Moran I statistic standard deviate = 2.7158, p-value =
0.003305
alternative hypothesis: greater
sample estimates:
Moran I statistic       Expectation          Variance 
      0.105901804      -0.009433962       0.001803527 

*15 km apart:*
Moran I test under randomisation

data:  sites_cf$av_agb_site  
weights: nb2listw(sites_neighbors_dist, zero.policy = T, style = "W")  n reduced by no-neighbour observations
  

Moran I statistic standard deviate = 1.9438, p-value =
0.02596
alternative hypothesis: greater
sample estimates:
Moran I statistic       Expectation          Variance 
      0.098077538      -0.009523810       0.003064303 

*10 km apart:*
Moran I test under randomisation

data:  sites_cf$av_agb_site  
weights: nb2listw(sites_neighbors_dist, zero.policy = T, style = "W")  n reduced by no-neighbour observations
  

Moran I statistic standard deviate = 1.1365, p-value =
0.1279
alternative hypothesis: greater
sample estimates:
Moran I statistic       Expectation          Variance 
      0.084236860      -0.010000000       0.006875416 

      
Run the analysis with sites that have at least 3 plots, to reduce some noise

```{r}
sites_subset <- sites_cf %>%
  filter(plot_no > 2)

#plot variables
plot(sites_subset[,c(10:14,18,20,34)]) 
plot(sites_subset[,c(12,13,18,20,34,40,48)])

#distance neighbors
loc_subs <- cbind(sites_subset$longitude, sites_subset$latitude)
d_subs <- 10 #distance has to be larger than the distance that exists between sites, which is 2.5 km
sites_subset_neighbors_dist <- dnearneigh(loc_subs, 0, d_subs, longlat = T)
str(sites_subset_neighbors_dist)
plot(sites_subset_neighbors_dist, loc_subs)

#Moran test
# spatial autocorrelation of dependent variable (AGB and Simpson)
moran.test(sites_subset$av_agb_site, zero.policy=T, 
     nb2listw(sites_subset_neighbors_dist, zero.policy=T, style="W"))

# Moran test with distance = 10
#Moran I statistic standard deviate = 2.9615, p-value = 0.001531
#alternative hypothesis: greater
#sample estimates:
#Moran I statistic       Expectation          Variance 
#       0.38509221       -0.01754386        0.01848425 

## Distance = 20
d_subs2 <- 20 #distance has to be larger than the distance that exists between sites, which is 2.5 km
sites_subset_neighbors_dist2 <- dnearneigh(loc_subs, 0, d_subs2, longlat = T)

plot(sites_subset_neighbors_dist2, loc_subs)

#Moran test
# spatial autocorrelation of dependent variable (AGB and Simpson)
moran.test(sites_subset$av_agb_site, zero.policy=T, 
     nb2listw(sites_subset_neighbors_dist2, zero.policy=T, style="W"))

#Moran I statistic standard deviate = 4.5796, p-value = 2.329e-06
#alternative hypothesis: greater
#sample estimates:
#Moran I statistic       Expectation          Variance 
#      0.317644918      -0.015151515       0.005280796 


## Distance = 5

d_subs3 <- 5 #distance has to be larger than the distance that exists between sites, which is 2.5 km
sites_subset_neighbors_dist3 <- dnearneigh(loc_subs, 0, d_subs3, longlat = T)

plot(sites_subset_neighbors_dist3, loc_subs)

#Moran test
# spatial autocorrelation of dependent variable (AGB and Simpson)
moran.test(sites_subset$av_agb_site, zero.policy=T, 
     nb2listw(sites_subset_neighbors_dist3, zero.policy=T, style="W"))

#Moran I statistic standard deviate = 0.47578, p-value = 0.3171
#alternative hypothesis: greater
#sample estimates:
#Moran I statistic       Expectation          Variance 
#       0.07981275       -0.03703704        0.06031799 
```
Let's explore distances between 5 and 10:

```{r}
#distance neighbors
loc_subs <- cbind(sites_subset$longitude, sites_subset$latitude)
d_subs <- 5 #distance has to be larger than the distance that exists between sites, which is 2.5 km
sites_subset_neighbors_dist <- dnearneigh(loc_subs, 0, d_subs, longlat = T)
str(sites_subset_neighbors_dist)
plot(sites_subset_neighbors_dist, loc_subs)

#Moran test
# spatial autocorrelation of dependent variable (AGB and Simpson)
moran.test(sites_subset$av_agb_site, zero.policy=T, 
     nb2listw(sites_subset_neighbors_dist, zero.policy=T, style="W"))

#10
#Moran I statistic standard deviate = 2.9615, p-value =0.001531
#alternative hypothesis: greater
#sample estimates:
#Moran I statistic       Expectation          Variance 
#       0.38509221       -0.01754386        0.01848425 

#9
#Moran I statistic standard deviate = 2.5088, p-value = 0.006056
#alternative hypothesis: greater
#sample estimates:
#Moran I statistic       Expectation          Variance 
#       0.34235874       -0.01923077        0.02077221 

#8
#Moran I statistic standard deviate = 2.5088, p-value =
#0.006056
#alternative hypothesis: greater
#sample estimates:
#Moran I statistic       Expectation          Variance 
#       0.34235874       -0.01923077        0.02077221

#7
#Moran I statistic standard deviate = 2.032, p-value =0.02108
#alternative hypothesis: greater
#sample estimates:
#Moran I statistic       Expectation          Variance 
#       0.33073160       -0.02325581        0.03034737

#6
#Moran I statistic standard deviate = 0.79832, p-value =0.2123
#alternative hypothesis: greater
#sample estimates:
#Moran I statistic       Expectation          Variance 
#       0.12408276       -0.02500000        0.03487432

#5
#Moran I statistic standard deviate = 0.47578, p-value =0.3171
#alternative hypothesis: greater
#sample estimates:
#Moran I statistic       Expectation          Variance 
#       0.07981275       -0.03703704        0.06031799
```


Moran test shows that there's spatial autocorrelation among sites that are at least 7 km apart when only sites with more than 2 plots are considered (closer than that, the neighborhoods are too small). When all sites are considered, Moran test is not significant at 10 km.
To account for this spatial autocorrelation, I'll cluster the data in subregions.
Fortunately, Toledo-Aceves et al (2011) already divided the NMO region in smaller subregions, which fit pretty well with the network of neighbors using d=10km.

First, let's conduct a Moran's I test with a diversity index.

```{r}
#distance neighbors
loc_subs <- cbind(sites_subset$longitude, sites_subset$latitude)
d_subs <- 10 #distance has to be larger than the distance that exists between sites, which is 2.5 km
sites_subset_neighbors_dist <- dnearneigh(loc_subs, 0, d_subs, longlat = T)
str(sites_subset_neighbors_dist)
plot(sites_subset_neighbors_dist, loc_subs)

#Moran test
# spatial autocorrelation of dependent variable (AGB and Simpson)
moran.test(sites_subset$simpson_av_site, zero.policy=T, 
     nb2listw(sites_subset_neighbors_dist, zero.policy=T, style="W"))
```
It's not significant in neighborhoods of 10 km.

Add a column with subregions to the data frame.
```{r}
sites_huautla <- read.csv("input/sites_huautla.csv", header = T)
sites_ixtlan <- read.csv("input/sites_ixtlan.csv", header = T)
sites_mixe <- read.csv("input/sites_mixe.csv", header = T)
sites_guevea <- read.csv("input/sites_guevea.csv", header = T)
```

Bind all subregions data sets in one and join to main data set

```{r}
subregions <- rbind(sites_huautla, sites_ixtlan, sites_mixe, sites_guevea)
subregions <- mutate(subregions, subregion = as.character(SUBREGIONE))
subregions <- select(subregions, -SUBREGIONE)
```



# Exploration model: effect of disturbance, succession*patchiness, and environmental factors

Generalized Linear Mixed Model (GLMM; when data is not normal)
Linear Mixed Effects Model (when data is normal)
Examples: 
http://mfviz.com/hierarchical-models/
https://ase.tufts.edu/bugs/guide/assets/mixed_model_guide.html
https://esajournals.onlinelibrary.wiley.com/doi/full/10.1002/ecy.3336
https://pjbartlein.github.io/GeogDataAnalysis/lec15.html
https://nlp.stanford.edu/manning/courses/ling289/GLMM.pdf
https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html
https://www.sciencedirect.com/science/article/pii/S0169534709000196
https://ourcodingclub.github.io/tutorials/mixed-models/
https://m-clark.github.io/mixed-models-with-R/random_intercepts.html
https://m-clark.github.io/generalized-additive-models/introduction.html

First, know your data. Is it normal?
http://www.sthda.com/english/wiki/normality-test-in-r
https://www.datanovia.com/en/lessons/normality-test-in-r/

```{r}
# First, explore correlation coefficients between variables

sites_cf %>%
  filter(plot_no > 2) %>%
  select(av_agb_site, longitude, latitude, altitude, temp, precip, average_slope, av_agb_site, shannon_av_site, simpson_av_site,sp_richness_site_av, mosaic) %>%
  na.omit() %>%
  cor()

sites_cf %>%
  filter(plot_no > 2) %>%
  select(av_agb_site, longitude, latitude, altitude, temp, precip, sp_richness_site_av, mosaic) %>%
  na.omit() %>%
  plot()

sites_cf %>%
  filter(plot_no > 2) %>%
  filter(mosaic > 0.5) %>%
  select(av_agb_site, longitude, latitude, altitude, temp, precip, average_slope, av_agb_site, shannon_av_site, simpson_av_site,sp_richness_site_av, mosaic) %>%
  na.omit() %>%
  cor()

# EXTRACT ASPECT WITH GEE 
sites_cf %>%
  filter(plot_no > 2) %>%
  filter(mosaic > 0.4) %>%
  ggplot(aes(x = landform, y = av_agb_site)) +
  geom_boxplot()

```
# Biomass and tree diversity over landscape composition