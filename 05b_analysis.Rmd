---
title: "05b_analysis"
author: "Adriana Uscanga"
date: "2023-02-07"
output: html_document
---

# Analysis: second round

Load packages and files

```{r}
# Files

load("output/sites_cf_4p.RData")
load("output/plots_cf_4p.RData")
load("output/trees_cf_4p.RData")

# Libraries

library(tidyverse)
library(ggplot2)
library(lme4)
library(corrplot)
library(vegan)

#library(rstatix)
#library(corrplot)
#library(vegan)
#library(leaps)
#library(asbio)
#library(spdep)
#library(ggpubr)
#library(multcompView)
```

## 1. Summary statistics and data exploration

```{r}

summary(plots_cf_4p)
summary(sites_cf_4p)

plots_cf_4p %>%
  ggplot(aes(x= agb_plot_ha)) +
  geom_histogram(bins = 20)

plots_cf_4p %>%
  ggplot(aes(x= log1p(agb_plot_ha))) +
  geom_histogram(bins = 20)

plots_cf_4p %>%
  ggplot(aes(x= t_shannon)) +
  geom_histogram(bins = 20)

plots_cf_4p %>%
  ggplot(aes(x= sp_richness_plot)) +
  geom_histogram(bins = 10)

```

```{r}
numeric_variables <- plots_cf_4p %>%
  select(temp, precip, ai, altitude, latitude, longitude, northness, eastness, slope, t_shannon, sp_richness_plot, agb_plot_ha, agriculture, grazing) %>%
  mutate(log_agb = log1p(agb_plot_ha)) %>%
  select(-agb_plot_ha)

corr <- cor(drop_na(numeric_variables[,-1]))
corrplot(corr, method = 'ellipse')
corrplot(corr, method = 'number')
plot(numeric_variables)
```
Environmental data is highly correlated, so I'm going to get rid of some of that collinearity with a PCA

```{r}
env <- plots_cf_4p %>%
  select(plot_id, temp, precip, ai, altitude, northness, eastness, slope)
env <- as.data.frame(env)
env$plot_id -> row.names(env)
env <- env[,c(-1, -2)]

pca_env <- rda(env, scale = T)
summary(pca_env)
plot(pca_env)
biplot(pca_env, display = 'species')

# PC1 (0.38) and PC2 (0.23) together explain 0.61 when lat and lon included
# PC1 (0.48) and PC2 (0.16) together explain 0.79 when lat and lon included

```

PC1:

```{r}
pc1 <- as.data.frame(pca_env$CA$u[,1])
colnames(pc1) <- "env_pc1"
pc1

plot(pc1[,1], plots_cf_4p$precip)
plot(pc1[,1], plots_cf_4p$ai)
plot(pc1[,1], plots_cf_4p$temp)
plot(pc1[,1], plots_cf_4p$altitude)

summary(lm(pc1[,1] ~ plots_cf_4p$precip))
summary(lm(pc1[,1] ~ plots_cf_4p$ai))
summary(lm(pc1[,1] ~ plots_cf_4p$temp))
summary(lm(pc1[,1] ~ plots_cf_4p$altitude))
```

PC2:

```{r}
pc2 <- as.data.frame(pca_env$CA$u[,2])
colnames(pc2) <- "env_pc2"
pc2

plot(pc2[,1], plots_cf_4p$slope)
plot(pc2[,1], plots_cf_4p$northness)
plot(pc2[,1], plots_cf_4p$eastness)

summary(lm(pc2[,1] ~ plots_cf_4p$slope))
summary(lm(pc2[,1] ~ plots_cf_4p$northness))
summary(lm(pc2[,1] ~ plots_cf_4p$eastness))

```
Slope and aspect are more related to PC2 but relationships are weak.
Correlation among them is also weak. 
To avoid colinearity, we are going to use PC1 (which encompasses temp, precip, elevation, and ai), slope and aspect.

```{r}
# Add PC1 values to dataset

class(pc1)

env_pc1 <- as_tibble(pc1, .name_repair = "minimal", rownames = "plot_id")


plots_cf_4p <- plots_cf_4p %>%
  left_join(env_pc1, by = "plot_id")
```

Linear mixed model

LMM with all variables and both subregion and site as nested random effects

```{r}
lmm <- lmer(log1p(agb_plot_ha) ~ env_pc1 + slope + northness + eastness + t_shannon + agriculture + grazing + (1|subregion/site), data = plots_cf_4p)

summary(lmm)
plot(lmm)
qqnorm(resid(lmm))
qqline(resid(lmm))

plot_model(lmm, show.values = T)
stargazer(lmm, type = "text")
```

LMM with all variables and sites as random effect

```{r}
lmm2 <- lmer(log1p(agb_plot_ha) ~ env_pc1 + slope + northness + eastness + t_shannon + agriculture + grazing + env_pc1*grazing + env_pc1*agriculture + env_pc1*t_shannon + t_shannon*grazing + t_shannon*agriculture + grazing*agriculture + (1|site), data = plots_cf_4p)

summary(lmm2)
plot(lmm2)
qqnorm(resid(lmm2))
qqline(resid(lmm2))

plot_model(lmm2, show.values = T)

stargazer(lmm2, type = "text")
```

Removing non-relevant variables

```{r}
lmm3 <- lmer(log1p(agb_plot_ha) ~ env_pc1 + slope + t_shannon + agriculture + grazing + (1|site), data = plots_cf_4p)

summary(lmm3)
plot(lmm3)
qqnorm(resid(lmm3))
qqline(resid(lmm3))

plot_model(lmm3, show.values = T)

stargazer(lmm3, type = "text")
```

Interactions

```{r}
lmm4 <- lmer(log1p(agb_plot_ha) ~ env_pc1 + slope + t_shannon + agriculture + env_pc1*agriculture + (1|site), data = plots_cf_4p)
stargazer(lmm4, type = "text")


lmm5 <- lmer(log1p(agb_plot_ha) ~ env_pc1 + slope + t_shannon + agriculture + env_pc1*agriculture + t_shannon*agriculture + (1|site), data = plots_cf_4p)
stargazer(lmm5, type = "text")

lmm6 <- lmer(log1p(agb_plot_ha) ~ env_pc1 + slope + t_shannon + agriculture +  env_pc1*grazing + t_shannon*agriculture + (1|site), data = plots_cf_4p)
summary(lmm6)
stargazer(lmm6, type = "text")
plot_model(lmm6, show.values = T)

```

```{r}

plots_cf_4p %>%
  ggplot(aes(x = t_shannon, y = log1p(agb_plot_ha), color = str_class_plots)) +
  geom_point()

sites_cf_4p %>%
  ggplot(aes(x = t_shannon_av_site, y = log(av_agb_site))) +
  geom_point()

```

