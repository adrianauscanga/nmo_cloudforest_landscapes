---
title: "05b_analysis"
author: "Adriana Uscanga"
date: "2023-02-07"
output: html_document
---

# Analysis: second round

Load packages and files

```{r}
# Files

load("output/sites_cf_4p.RData")
load("output/plots_cf_4p.RData")
load("output/trees_cf_4p.RData")

# Libraries

library(tidyverse)
library(ggplot2)
library(lme4)
library(corrplot)
library(vegan)
library(stargazer)
library(sjPlot)

#library(rstatix)
#library(corrplot)
#library(vegan)
#library(leaps)
#library(asbio)
#library(spdep)
#library(ggpubr)
#library(multcompView)
```

## 1. Summary statistics and data exploration

```{r}

summary(plots_cf_4p)
summary(sites_cf_4p)

plots_cf_4p %>%
  ggplot(aes(x= agb_plot_ha)) +
  geom_histogram(bins = 25)

plots_cf_4p %>%
  ggplot(aes(x= log1p(agb_plot_ha))) +
  geom_histogram(bins = 20)

plots_cf_4p %>%
  ggplot(aes(x= t_shannon)) +
  geom_histogram(bins = 20)

plots_cf_4p %>%
  ggplot(aes(x= sp_richness_plot)) +
  geom_histogram(bins = 10)

```

```{r}
numeric_variables <- plots_cf_4p %>%
  select(temp, precip, ai, altitude, latitude, longitude, northness, eastness, slope, t_shannon, sp_richness_plot, agb_plot_ha, agriculture, grazing) %>%
  mutate(log_agb = log1p(agb_plot_ha)) %>%
  select(-agb_plot_ha)

corr <- cor(drop_na(numeric_variables[,-1]))
corrplot(corr, method = 'ellipse')
corrplot(corr, method = 'number')
plot(numeric_variables)
```
Environmental data is highly correlated, so I'm going to get rid of some of that collinearity with a PCA

```{r}
env <- plots_cf_4p %>%
  select(plot_id, temp, precip, ai, altitude, northness, eastness, slope)
env <- as.data.frame(env)
env$plot_id -> row.names(env)
env <- env[,c(-1, -2)]

pca_env <- rda(env, scale = T)
summary(pca_env)
plot(pca_env)
biplot(pca_env, display = 'species')

# PC1 (0.38) and PC2 (0.23) together explain 0.61 when lat and lon included
# PC1 (0.48) and PC2 (0.16) together explain 0.64 when lat and lon excluded

```

PC1:

```{r}
pc1 <- as.data.frame(pca_env$CA$u[,1])
colnames(pc1) <- "env_pc1"
pc1

plot(pc1[,1], plots_cf_4p$precip)
plot(pc1[,1], plots_cf_4p$ai)
plot(pc1[,1], plots_cf_4p$temp)
plot(pc1[,1], plots_cf_4p$altitude)

summary(lm(pc1[,1] ~ plots_cf_4p$precip))
summary(lm(pc1[,1] ~ plots_cf_4p$ai))
summary(lm(pc1[,1] ~ plots_cf_4p$temp))
summary(lm(pc1[,1] ~ plots_cf_4p$altitude))
```

PC2:

```{r}
pc2 <- as.data.frame(pca_env$CA$u[,2])
colnames(pc2) <- "env_pc2"
pc2

plot(pc2[,1], plots_cf_4p$slope)
plot(pc2[,1], plots_cf_4p$northness)
plot(pc2[,1], plots_cf_4p$eastness)

summary(lm(pc2[,1] ~ plots_cf_4p$slope))
summary(lm(pc2[,1] ~ plots_cf_4p$northness))
summary(lm(pc2[,1] ~ plots_cf_4p$eastness))

```
Slope and aspect are more related to PC2 but relationships are weak.
Correlation among them is also weak. 
To avoid colinearity, we are going to use PC1 (which encompasses temp, precip, elevation, and ai), slope and aspect.

```{r}
# Add PC1 values to dataset

class(pc1)

env_pc1 <- as_tibble(pc1, .name_repair = "minimal", rownames = "plot_id")


plots_cf_4p <- plots_cf_4p %>%
  left_join(env_pc1, by = "plot_id")
```

Linear mixed model

LMM with all variables and site as random effect

```{r}
lmm <- lmer(log1p(agb_plot_ha) ~ env_pc1 + slope + northness + eastness + t_shannon + agriculture + grazing + (1| site), data = plots_cf_4p)

summary(lmm)
plot(lmm)
qqnorm(resid(lmm))
qqline(resid(lmm))

plot_model(lmm, show.values = T)
stargazer(lmm, type = "text")
```

LMM with all variables, interactions among them, and sites as random effect

```{r}
lmm2 <- lmer(log1p(agb_plot_ha) ~ env_pc1 + slope + northness + eastness + t_shannon + agriculture + grazing + env_pc1*slope + slope*agriculture + slope*t_shannon + slope*grazing + env_pc1*grazing + env_pc1*agriculture + env_pc1*t_shannon + t_shannon*grazing + t_shannon*agriculture + grazing*agriculture + (1|site), data = plots_cf_4p)

summary(lmm2)
plot(lmm2)
qqnorm(resid(lmm2))
qqline(resid(lmm2))

plot_model(lmm2, show.values = T)

stargazer(lmm2, type = "text")
```
Lower AIC. 
I'll remove non-relevant variables first, and then non-relevant interactions:

```{r}
lmm3 <- lmer(log1p(agb_plot_ha) ~ env_pc1 + slope + t_shannon + agriculture + grazing + (1|site), data = plots_cf_4p)

summary(lmm3)
plot(lmm3)
qqnorm(resid(lmm3))
qqline(resid(lmm3))

plot_model(lmm3, show.values = T)

stargazer(lmm3, type = "text")
```
This is the best model so far, although grazing is non-significant.
Let's add the relevant interactions:

```{r}
lmm4 <- lmer(log1p(agb_plot_ha) ~ env_pc1 + slope + t_shannon + agriculture + t_shannon*agriculture + slope*t_shannon + env_pc1*grazing + (1|site), data = plots_cf_4p)

summary(lmm4)
stargazer(lmm4, type = "text")
plot_model(lmm4, show.values = T)

```
I'll remove the only interaction that wasn't statistically significant:

```{r}
lmm5 <- lmer(log1p(agb_plot_ha) ~ env_pc1 + slope + t_shannon + agriculture + t_shannon*agriculture + env_pc1*grazing + (1|site), data = plots_cf_4p)

summary(lmm5)
stargazer(lmm5, type = "text")
plot_model(lmm5, show.values = T)
```
Best model thus far.

```{r}

plots_cf_4p %>%
  ggplot(aes(x = t_shannon, y = log1p(agb_plot_ha))) +
  geom_point(aes(color = str_class_plots)) +
  geom_smooth(method = "lm")

plots_cf_4p %>%
  ggplot(aes(y = t_shannon, x = agriculture)) +
  geom_point(aes(color = str_class_plots)) +
  geom_smooth(method = "lm")

plots_cf_4p %>%
  ggplot(aes(y = t_shannon, x = grazing)) +
  geom_point(aes(color = str_class_plots)) +
  geom_smooth(method = "lm")

plots_cf_4p %>%
  ggplot(aes(x = agriculture, y = log1p(agb_plot_ha))) +
  geom_point(aes(color = str_class_plots)) +
  geom_smooth(method = "lm")

plots_cf_4p %>%
  ggplot(aes(x = slope, y = log1p(agb_plot_ha))) +
  geom_point(aes(color = str_class_plots)) +
  geom_smooth(method = "lm")

plots_cf_4p %>%
  ggplot(aes(x = grazing, y = log1p(agb_plot_ha))) +
  geom_point(aes(color = str_class_plots)) +
  geom_smooth(method = "lm")

plots_cf_4p %>%
  ggplot(aes(x = env_pc1, y = agriculture)) +
  geom_point(aes(color = str_class_plots)) +
  geom_smooth(method = "lm")

plots_cf_4p %>%
  ggplot(aes(x = altitude, y = agriculture)) +
  geom_point(aes(color = str_class_plots)) +
  geom_smooth(method = "lm")

plots_cf_4p %>%
  ggplot(aes(x = altitude, y = grazing)) +
  geom_point(aes(color = str_class_plots)) +
  geom_smooth(method = "lm")

plots_cf_4p %>%
  ggplot(aes(x = env_pc1, y = grazing)) +
  geom_point(aes(color = str_class_plots)) +
  geom_smooth(method = "lm")

plots_cf_4p %>%
  ggplot(aes(x = env_pc1, y = t_shannon)) +
  geom_point(aes(color = str_class_plots)) +
  geom_smooth(method = "lm")

plots_cf_4p %>%
  ggplot(aes(x = env_pc1, y = log1p(agb_plot_ha))) +
  geom_point(aes(color = str_class_plots)) +
  geom_smooth(method = "lm")

```

GLMM: agb ~ diversity

Name | Link Function | Distribution
General linear model | Identity | Normal
Logistic regression | Logit | Binomial
Poisson | Log | Poisson
Gamma | Inverse | Gamma

```{r}

glmm1 <- glmer((scale(agb_plot_ha)+1) ~ t_shannon + (1|site), Gamma(link = "inverse"), data = plots_cf_4p, nAGQ = 2, glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)))
summary(glmm1)

glmm1b <- glmer((scale(agb_plot_ha)+1) ~ sp_richness_plot + (1|site), Gamma(link = "inverse"), data = plots_cf_4p, nAGQ = 2, glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)))
summary(glmm1b)

lmer1 <- lmer(log1p(agb_plot_ha) ~ t_shannon + (1|site), data = plots_cf_4p)
summary(lmer1)
plot(lmer1)
stargazer(lmer1, type = "text")

lmer1b <- lmer(agb_plot_ha ~ t_shannon + (1|site), data = plots_cf_4p)
summary(lmer1b)
plot(lmer1b)
stargazer(lmer1b, type = "text")

glmm1c <- glmer((log1p(agb_plot_ha+1)) ~ t_shannon + (1|site), Gamma(link = "inverse"), data = plots_cf_4p, nAGQ = 2, glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)))
summary(glmm1c)
plot(glmm1c)
```

GMM: agb ~ all variables

```{r}

glmm2 <- glmer((scale(agb_plot_ha)+1) ~ env_pc1 + slope + t_shannon + agriculture + grazing + (1|site), Gamma(link="inverse"), data = plots_cf_4p, glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)))
summary(glmm2)

```


With interactions:

```{r}

glmm3 <- glmer((scale(agb_plot_ha)+1) ~ agriculture + env_pc1*grazing +  t_shannon*agriculture + (1|site), Gamma(link="inverse"), data = plots_cf_4p, glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)))
summary(glmm3)

```

Plots classification

Option 1: k-means including PC1
```{r}
plots_str2 <- plots_cf_4p %>%
  select(plot_id,
         tree_density,
         loreys_height,
         basal_area_ha,
         agb_plot_ha,
         env_pc1)

plot(plots_str2)

# Scale data so that variables in different units can be compared
plots_str_scaled2 <- scale(plots_str2[,-c(1,2,5)])
row.names(plots_str_scaled2) <- plots_str2$plot_id

k2_structure_plots2 <- kmeans(plots_str_scaled2, centers = 2, nstart = 25)
k3_structure_plots2 <- kmeans(plots_str_scaled2, centers = 3, nstart = 25)
k4_structure_plots2 <- kmeans(plots_str_scaled2, centers = 4, nstart = 25)
k5_structure_plots2 <- kmeans(plots_str_scaled2, centers = 5, nstart = 25)

p1_str_plots2 <- fviz_cluster(k2_structure_plots2, geom = "point", data = plots_str_scaled2) + ggtitle("k = 2")
p2_str_plots2 <- fviz_cluster(k3_structure_plots2, geom = "point",  data = plots_str_scaled2) + ggtitle("k = 3")
p3_str_plots2 <- fviz_cluster(k4_structure_plots2, geom = "point",  data = plots_str_scaled2) + ggtitle("k = 4")
p4_str_plots2 <- fviz_cluster(k5_structure_plots2, geom = "point",  data = plots_str_scaled2) + ggtitle("k = 5")
grid.arrange(p1_str_plots2, p2_str_plots2, p3_str_plots2, p4_str_plots2, nrow = 2)

str_clusters_plots2 <- NbClust((plots_str_scaled2^2), distance = "euclidean", min.nc = 2, max.nc = 10, method = "ward.D2", index = "all")

# Save a vector of 2 clusters:
str_k2_plots2 <- k2_structure_plots2$cluster
as.numeric(str_k2_plots2)

#pca with structural data

pca_str_plots2 <- rda(plots_str_scaled2, scale = F)
summary(pca_str_plots2) # 
plot(pca_str_plots2)

ordiplot(pca_str_plots2, display = 'sites', type = 'n')
points(pca_str_plots2, col = str_k2_plots2)
biplot(pca_str_plots2, display = 'species')

ordiplot(pca_str_plots, display = 'sites', type = 'text')
biplot(pca_str_plots)

ordiplot(pca_str_plots2, display = 'sites', type = 'n')
points(pca_str_plots, col = str_k3_plots)
biplot(pca_str_plots, display = 'species')

ordiplot(pca_str_plots, display = 'sites', type = 'text')
biplot(pca_str_plots)

plots_cf_4p %>%
  ggplot(aes(x= str_class_plots, y = agriculture, color = basal_area_ha)) +
  geom_jitter()

plots_cf_4p %>%
  ggplot(aes(x= str_class_plots, y = grazing)) +
  geom_jitter(color = 'blue')

plots_cf_4p %>%
  filter(str_class_plots == 1) %>%
  ggplot(aes(x = env_pc1, y = loreys_height, color = as.factor(agriculture))) +
  geom_point()

plots_cf_4p %>%
  filter(str_class_plots == 2) %>%
  ggplot(aes(x = altitude, y = agb_plot_ha, color = as.factor(agriculture))) +
  geom_point()

plots_cf_4p %>%
  filter(str_class_plots == 3) %>%
  ggplot(aes(x = altitude, y = agb_plot_ha, color = as.factor(agriculture))) +
  geom_point()


plots_cf_4p %>%
  filter(str_class_plots == 1) %>%
  arrange(agriculture, -altitude)

plots_cf_4p %>%
  mutate(land_use = agriculture + grazing) %>%
  ggplot(aes(x = str_class_plots, y = land_use)) +
  geom_jitter()
  
```


Option 1: PCA?