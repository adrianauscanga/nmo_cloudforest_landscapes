---
title: "06_figures"
author: "Adriana Uscanga"
date: "19/2/2022"
output: html_document
---

# Figures
 
```{r}
# Note: Run 05_analyisis first to have all needed data loaded

# Load packages for making figures:
library(ggplot2)
library(ggpubr)
library(cowplot)
library(rlang)
library(ggsignif)

```

## Figure 2. 


```{r}

# Panel a: PCA showing k means results with structural attributes

# Ordination of plots according to their structural attributes

plots_str <- trees_cf_4p %>%
  filter(!is.na(mean_wd)) %>%
  group_by(plot_id) %>%
  summarise(mean_wd_plot = mean(mean_wd),
            sd_wd_plot = sd(mean_wd)) %>%
  right_join(plots_cf_4p) %>%
  mutate(mean_wd_plot = ifelse(tree_no == 0, 0, mean_wd_plot),
         sd_wd_plot = ifelse(tree_no == 0, 0, sd_wd_plot)) %>%
  select(plot_id,
         tree_density,
         loreys_height,
         basal_area_ha,
         mean_wd_plot,
         agb_plot_ha)

# Scale data so that variables in different units can be compared
plots_str_scaled <- scale(plots_str[,-c(1,5,6)])
row.names(plots_str_scaled) <- plots_str$plot_id

#pca with structural data

pca_str_plots <- rda(plots_str_scaled, scale = F)
summary(pca_str_plots)  
plot(pca_str_plots)

# save PCA scores to plot them with ggplot:
pca_scores <- scores(pca_str_plots)
pca_scores_plots <- as.data.frame(pca_scores$sites)
pca_scores_plots <- pca_scores_plots %>%
  as_tibble(rownames = "plot_id") %>%
  left_join(plots_cf_4p)

pca_scores$species
#                   PC1        PC2
# tree_density  -1.963334  1.8030877
# loreys_height -2.189246 -1.4634938
# basal_area_ha -2.567017 -0.1309365

pa <- pca_scores_plots %>%
  mutate(succ = ifelse(str_class_plots == "1", "F",
                       ifelse(str_class_plots == "2", "Y", "M"))) %>%
  ggplot(aes(x = PC1, y = PC2, color = factor(succ, levels = c("F","Y", "M"),ordered = TRUE))) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  geom_point() +
  guides(color = guide_legend(override.aes = list(size = 2.5))) +
  scale_color_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  theme_classic() +
  scale_x_continuous(limits = c(-2.5,2),
                     breaks = c(-2.5, -2, -1.5, -1, -0.5, 0, 0.5, 1, 1.5, 2)) +
  scale_y_continuous(limits = c(-2.5,2),
                     breaks = c(-2.5, -2, -1.5, -1, -0.5, 0, 0.5, 1, 1.5, 2)) +
  geom_segment(aes(x = 0, y = 0, xend = -1.96, yend = 1.80),
               color = "gray40",
               arrow = arrow(length = unit(0.2,"cm"))) +
  geom_text(aes(x= -1.95, y= 2, label = "Stem density"),
            color = "gray25",
            size = 3) +
  geom_segment(aes(x = 0, y = 0, xend = -2.1, yend =  -1.4),
               color = "gray40",
               arrow = arrow(length = unit(0.2,"cm"))) +
  geom_text(aes(x= -2.2, y= -1.6, label = "Lorey's height"),
            color = "gray25",
            size = 3) +
  geom_segment(aes(x = 0, y = 0, xend = -2.5, yend = -0.1),
               color = "gray40",
               arrow = arrow(length = unit(0.2,"cm"))) +
  geom_text(aes(x= -2.3, y= -0.25, label = "Basal area"),
            color = "gray25",
            size = 3) +
  theme(legend.title = element_blank(),
        legend.position = c(0.9, 0.8),
        legend.background = element_rect(linetype = "solid", size = 0.01, color = "gray50"))

pa


# Structural attributes across succesional stages

## List of comparisons for stats
comp <- list(c("F","Y"), c("F","M"), c("Y","M"))

# Panel b: stem density

pb <- plots_cf_4p %>%
  mutate(succ = ifelse(str_class_plots == "1", "F",
                       ifelse(str_class_plots == "2", "Y", "M"))) %>%
  ggplot(aes(x= factor(succ, levels = c("F","Y", "M"),ordered = TRUE), y = tree_density, fill = factor(succ, levels = c("F","Y", "M"),ordered = TRUE))) +
  geom_boxplot(color = "gray25",
               outlier.alpha = 0.5,
               outlier.color = "gray40",
               outlier.size = 1.2) +
  stat_compare_means(comparisons = comp,
                     label = "p.signif") +
  theme_classic() +
  scale_fill_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  theme(axis.title.x = element_blank()) +
  labs(y = (bquote('Stem density ( '*"tree"~ha^-1*')'))) +
  theme(axis.title.y = element_text(size = 10)) +
  theme(axis.text = element_text(size = 9)) +
  theme(legend.position = "none") 

# Panel c: lorey's height

pc <- plots_cf_4p %>%
  mutate(succ = ifelse(str_class_plots == "1", "F",
                       ifelse(str_class_plots == "2", "Y", "M"))) %>%
  ggplot(aes(x= factor(succ, levels = c("F","Y", "M"),ordered = TRUE), y = loreys_height, fill = factor(succ, levels = c("F","Y", "M"),ordered = TRUE))) +
  geom_boxplot(color = "gray25",
               outlier.alpha = 0.5,
               outlier.color = "gray40",
               outlier.size = 1.2) +
  stat_compare_means(comparisons = comp,
                     label = "p.signif") +
  theme_classic() +
  scale_fill_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  theme(axis.title.x = element_blank()) +
  labs(y = "Lorey's height (m)") +
  theme(axis.title.y = element_text(size = 10)) +
  theme(axis.text = element_text(size = 9)) +
  theme(legend.position = "none") 

# Panel d: basal area

pd <- plots_cf_4p %>%
  mutate(succ = ifelse(str_class_plots == "1", "F",
                       ifelse(str_class_plots == "2", "Y", "M"))) %>%
  ggplot(aes(x= factor(succ, levels = c("F","Y", "M"),ordered = TRUE), y = basal_area_ha, fill = factor(succ, levels = c("F","Y", "M"),ordered = TRUE))) +
  geom_boxplot(color = "gray25",
               outlier.alpha = 0.5,
               outlier.color = "gray40",
               outlier.size = 1.2) +
  stat_compare_means(comparisons = comp,
                     label = "p.signif") +
  theme_classic() +
  scale_fill_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  theme(axis.title.x = element_blank()) +
  labs(y = (bquote('Basal Area ('*"m"~ha^-1*')'))) +
  theme(axis.title.y = element_text(size = 10)) +
  theme(axis.text = element_text(size = 9)) +
  theme(legend.position = "none") 

# Panel e: wood density

pe <- plots_str <- trees_cf_4p %>%
  filter(!is.na(mean_wd)) %>%
  group_by(plot_id) %>%
  summarise(mean_wd_plot = mean(mean_wd),
            sd_wd_plot = sd(mean_wd)) %>%
  right_join(plots_cf_4p) %>%
  mutate(succ = ifelse(str_class_plots == "1", "F",
                       ifelse(str_class_plots == "2", "Y", "M"))) %>%
  mutate(mean_wd_plot = ifelse(tree_no == 0, 0, mean_wd_plot),
         sd_wd_plot = ifelse(tree_no == 0, 0, sd_wd_plot)) %>%
  ggplot(aes(x= factor(succ, levels = c("F","Y", "M"),ordered = TRUE),
             y = mean_wd_plot,
             fill = factor(succ, levels = c("F","Y", "M"),ordered = TRUE))) +
  geom_boxplot(color = "gray25",
               outlier.alpha = 0.5,
               outlier.color = "gray40",
               outlier.size = 1.2) +
  stat_compare_means(comparisons = comp,
                     label = "p.signif") +
  theme_classic() +
  scale_fill_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  theme(axis.title.x = element_blank()) +
  labs(y = (bquote('Wood density ('*"g"~cm^-3*')'))) +
  theme(axis.title.y = element_text(size = 10)) +
  theme(axis.text = element_text(size = 9)) +
  theme(legend.position = "none") 

# Panel f: AGB

pf <- plots_cf_4p %>%
  mutate(succ = ifelse(str_class_plots == "1", "F",
                       ifelse(str_class_plots == "2", "Y", "M"))) %>%
  ggplot(aes(x= factor(succ, levels = c("F","Y", "M"),ordered = TRUE), y = agb_plot_ha, fill = factor(succ, levels = c("F","Y", "M"),ordered = TRUE))) +
  geom_boxplot(color = "gray25",
               outlier.alpha = 0.5,
               outlier.color = "gray40",
               outlier.size = 1.2) +
  stat_compare_means(comparisons = comp,
                     label = "p.signif") +
  theme_classic() +
  scale_fill_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  theme(axis.title.x = element_blank()) +
  labs(y = (bquote('AGB ('*"Mg"~ha^-1*')'))) +
  theme(axis.title.y = element_text(size = 10)) +
  theme(axis.text = element_text(size = 9)) +
  theme(legend.title = element_blank(),
        legend.box = "horizontal") 

pf2 <- pf + theme(legend.position = "none")
l <- get_legend(pf)

figure2 <- ggarrange(pa, pb, pc, pd, pe, pf2,
                  ncol = 2,
                  nrow = 3,
                  labels = c("a)", "b)", "c)", "d)", "e)", "f)"),
                  font.label = list(size= 10),
                  common.legend = F)


                  # common.legend = T,
                  # legend.grob = l,
                  # legend= "right")
figure2

```


## Figure 3. Structural attributes and tree size contribution to AGB and stem density at plot level

```{r}

# Tree size contribution to stem density

## Data frame for plot 1

p1_df <- plots_cf_4p %>%
  select(plot_id, tree_no, str_class_plots) %>%
  right_join(stems_class_plot, by = "plot_id") %>%
  mutate(stem_prop = stems/tree_no)  %>%
  mutate(succ = ifelse(str_class_plots == "1", "F",
                       ifelse(str_class_plots == "2", "Y", "M"))) %>%
  mutate(size_class = ifelse(diam_class == "1", "<10",
                             ifelse(diam_class == "2", "10-20",
                                    ifelse(diam_class == "3", "20-30",
                                           ifelse(diam_class == "4", "30-40",
                                                  ifelse(diam_class == "5", "40-50", ">50"))))))

## Stats

### Statistical differences between successional stages within size classes
# stat_test <- p1_df %>%
#   group_by(diam_class) %>%
#   t_test(stem_prop ~ str_class_plots) %>%
#   adjust_pvalue(method = "bonferroni") %>%
#   add_significance("p.adj")
# stat_test
# 
# stat_test <- stat_test %>%
#   add_xy_position(x= "diam_class", dodge = 0.8, group = "str_class_plots") %>% 
#   # Change y position of statistical differences
#   mutate(y.position = ifelse(diam_class == "1" &
#                                group1 == "1" &
#                                group2 == "2", 1.0, y.position)) %>%
#   mutate(y.position = ifelse(diam_class == "1" &
#                                group1 == "1" &
#                                group2 == "3", 1.1, y.position)) %>%
#   mutate(y.position = ifelse(diam_class == "6" &
#                                group1 == "2" &
#                                group2 == "3", 0.28, y.position))
# 
# ### Statistical differences between size classes within successional stages
# 
# stat_test2 <- p1_df %>%
#   group_by(str_class_plots) %>%
#   t_test(stem_prop ~ diam_class) %>%
#   adjust_pvalue(method = "bonferroni") %>%
#   add_significance("p.adj") 
# 
# #### Groupings resulted from stat_test2
# 
# c1 <- rep(c(1, 2, 3), each = 6)
# c2 <- rep(seq(1, 6), times = 3)
# c3 <- list(c("a", "b", "b", "b", "b", "b",
#        "a", "b", "c", "d", "d", "d",
#        "a", "b", "ac", "cd", "d", "d"))
# 
# groupings <- data.frame(c1, c2, c3) 
# colnames(groupings) <- c("str_class_plots", "diam_class", "groupings")
# 
# groupings <- groupings %>%
#   as_tibble() %>%
#   arrange(diam_class) %>%
#   mutate(succ = ifelse(str_class_plots == "1", "F",
#                        ifelse(str_class_plots == "2", "Y", "M"))) %>%
#   mutate(size_class = ifelse(diam_class == "1", "<10",
#                              ifelse(diam_class == "2", "10-20",
#                                     ifelse(diam_class == "3", "20-30",
#                                            ifelse(diam_class == "4", "30-40",
#                                                   ifelse(diam_class == "5", "40-50", ">50"))))))
# 
# groupings <- groupings %>%
#   mutate(x_groupings = c(0.7333333, 1.000000, 1.266667, 1.7333333, 2.000000, 2.266667,
#                2.7333333, 3.000000, 3.266667, 3.7333333, 4.000000, 4.266667,
#                4.7333333, 5.000000, 5.266667, 5.7333333, 6.000000, 6.266667))
# 
# groupings <- groupings %>%
#   as_tibble() %>%
#   mutate(str_class_plots = as.character(str_class_plots),
#          diam_class = as.character(diam_class))
# 
# p1_df <- p1_df %>%
#   left_join(groupings, by = c("str_class_plots", "diam_class", "succ", "size_class"))
# 

################## With ANOVA and Tukey ###################

### Statistical differences between successional stages within size classes

ap1 <- p1_df %>%
  group_by(diam_class) %>%
  anova_test(stem_prop ~ succ)

tukeyp1 <- p1_df %>%
  group_by(diam_class) %>%
  tukey_hsd(stem_prop ~ str_class_plots)

tukeyp1 <- tukeyp1 %>%
  add_xy_position(x= "diam_class", dodge = 0.8, group = "str_class_plots") %>%
  # Change y position of statistical differences
  mutate(y.position = ifelse(diam_class == "1" &
                               group1 == "1" &
                               group2 == "2", 1.0, y.position)) %>%
  mutate(y.position = ifelse(diam_class == "1" &
                               group1 == "1" &
                               group2 == "3", 1.1, y.position)) %>%
  mutate(y.position = ifelse(diam_class == "4" &
                               group1 == "1" &
                               group2 == "2", 1.1, y.position)) %>%
  mutate(y.position = ifelse(diam_class == "6" &
                               group1 == "2" &
                               group2 == "3", 0.40, y.position))

### Statistical differences between size classes within successional stages

a2p1 <- p1_df %>%
  group_by(succ) %>%
  anova_test(stem_prop ~ diam_class)

tukey2p1 <- p1_df %>%
  group_by(succ) %>%
  tukey_hsd(stem_prop ~ diam_class)

# Groupings for F forests

tukey2p1_F <- tukey2p1 %>%
  filter(succ == "F") %>%
  select(group1, group2, p.adj.signif) %>%
  unite("comparisons", group1, group2, sep = "-") %>%
  mutate(dif = ifelse(p.adj.signif == "ns", FALSE, TRUE))

dif <- tukey2p1_F$dif
names(dif) <- tukey2p1_F$comparisons
difL <- multcompLetters(dif)
difL


# Groupings for Y forests

tukey2p1_y <- tukey2p1 %>%
  filter(succ == "Y") %>%
  select(group1, group2, p.adj.signif) %>%
  unite("comparisons", group1, group2, sep = "-") %>%
  mutate(dif = ifelse(p.adj.signif == "ns", FALSE, TRUE))

dify <- tukey2p1_y$dif
names(dify) <- tukey2p1_y$comparisons
difyL <- multcompLetters(dify)
difyL


# Groupings for M forests

tukey2p1_m <- tukey2p1 %>%
  filter(succ == "M") %>%
  select(group1, group2, p.adj.signif) %>%
  unite("comparisons", group1, group2, sep = "-") %>%
  mutate(dif = ifelse(p.adj.signif == "ns", FALSE, TRUE))

difm <- tukey2p1_m$dif
names(difm) <- tukey2p1_y$comparisons
difmL <- multcompLetters(difm)
difmL

#### Groupings resulted from anovas and tukey tests

c1 <- rep(c(1, 2, 3), each = 6)
c2 <- rep(seq(1, 6), times = 3)
c3 <- list(c("a", "a", "b", "b", "b", "b",
       "a", "b", "c", "d", "d", "d",
       "a", "b", "ac", "cd", "d", "d"))

groupings <- data.frame(c1, c2, c3) 
colnames(groupings) <- c("str_class_plots", "diam_class", "groupings")

groupings <- groupings %>%
  as_tibble() %>%
  arrange(diam_class) %>%
  mutate(succ = ifelse(str_class_plots == "1", "F",
                       ifelse(str_class_plots == "2", "Y", "M"))) %>%
  mutate(size_class = ifelse(diam_class == "1", "<10",
                             ifelse(diam_class == "2", "10-20",
                                    ifelse(diam_class == "3", "20-30",
                                           ifelse(diam_class == "4", "30-40",
                                                  ifelse(diam_class == "5", "40-50", ">50"))))))

groupings <- groupings %>%
  mutate(x_groupings = c(0.7333333, 1.000000, 1.266667, 1.7333333, 2.000000, 2.266667,
               2.7333333, 3.000000, 3.266667, 3.7333333, 4.000000, 4.266667,
               4.7333333, 5.000000, 5.266667, 5.7333333, 6.000000, 6.266667))

groupings <- groupings %>%
  as_tibble() %>%
  mutate(str_class_plots = as.character(str_class_plots),
         diam_class = as.character(diam_class))

p1_df <- p1_df %>%
  left_join(groupings, by = c("str_class_plots", "diam_class", "succ", "size_class"))


## Plot

p1 <- p1_df %>%
  group_by(succ, diam_class) %>%
  # plot
  ggplot(aes(x = factor(size_class, 
                        levels =c("<10", "10-20", "20-30", "30-40", "40-50", ">50"),
                        ordered = TRUE),
             y = stem_prop)) +
  geom_boxplot(aes(fill = factor(succ,
                           levels = c("F","Y", "M"),
                           ordered = TRUE)),
             color = "gray25",
               outlier.alpha = 0.5,
               outlier.color = "gray40",
               outlier.size = 1.5) +
  # stat_pvalue_manual(stat_test,
  #                    tip.length = 0.01,
  #                    hide.ns = T,
  #                    bracket.size = 0.5) +
  stat_pvalue_manual(tukeyp1,
                     tip.length = 0.01,
                     hide.ns = T,
                     bracket.size = 0.5) +
  geom_text(aes(x= x_groupings,
                y= -0.05,
                label = groupings,
                color = factor(succ,
                           levels = c("F","Y", "M"),
                           ordered = TRUE)),
                size = 3) +
  scale_color_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  scale_fill_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  scale_y_continuous(breaks = c(0.0, 0.25, 0.50, 0.75, 1.0)) +
  theme_classic() +
  labs(x = "Size class",
       y = "Proportion of stems") +
  theme(axis.title.x = element_text(size = 10)) +
  theme(axis.title.y = element_text(size = 9)) +
  theme(axis.text = element_text(size = 8)) +
  theme(legend.position = c(0.9,0.9)) +
  theme(legend.title = element_blank()) +
  theme(plot.margin = margin(b= 10, t= 9))


# Tree size contribution to AGB

## Data frame for plot 2

p2_df <- plots_cf_4p %>%
  select(plot_id, agb_plot, str_class_plots) %>%
  right_join(agb_class_plots, by = "plot_id") %>%
  mutate(agb_prop = agb_class_plot/agb_plot)  %>%
  mutate(succ = ifelse(str_class_plots == "1", "F",
                       ifelse(str_class_plots == "2", "Y", "M"))) %>%
  mutate(size_class = ifelse(diam_class == "1", "<10",
                             ifelse(diam_class == "2", "10-20",
                                    ifelse(diam_class == "3", "20-30",
                                           ifelse(diam_class == "4", "30-40",
                                                  ifelse(diam_class == "5", "40-50", ">50"))))))

## Stats

# ### Statistical differences between successional stages within size classes
# stat_test_p2 <- p2_df %>%
#   group_by(diam_class) %>%
#   t_test(agb_prop ~ str_class_plots) %>%
#   adjust_pvalue(method = "bonferroni") %>%
#   add_significance("p.adj")
# 
# stat_test_p2
# 
# stat_test_p2 <- stat_test_p2 %>%
#   add_xy_position(x= "diam_class", dodge = 0.8, group = "str_class_plots") %>% 
#   #Change y position of statistical differences
#   mutate(y.position = ifelse(diam_class == "1" &
#                                group1 == "1" &
#                                group2 == "3", 0.90, y.position)) %>%
#   mutate(y.position = ifelse(diam_class == "1" &
#                                group1 == "2" &
#                                group2 == "3", 1.0, y.position)) %>%
#   mutate(y.position = ifelse(diam_class == "2" &
#                               group1 == "1" &
#                               group2 == "3", 1.1, y.position)) %>%
#   mutate(y.position = ifelse(diam_class == "2" &
#                               group1 == "2" &
#                               group2 == "3", 1.2, y.position)) %>%
#   mutate(y.position = ifelse(diam_class == "3" &
#                               group1 == "1" &
#                               group2 == "3", 1.1, y.position)) %>%
#   mutate(y.position = ifelse(diam_class == "3" &
#                               group1 == "2" &
#                               group2 == "3", 1.2, y.position)) %>%
#   mutate(y.position = ifelse(diam_class == "4" &
#                               group1 == "1" &
#                               group2 == "2", 1.1, y.position)) %>%
#   mutate(y.position = ifelse(diam_class == "4" &
#                               group1 == "1" &
#                               group2 == "3", 1.2, y.position)) %>%
#   mutate(y.position = ifelse(diam_class == "5" &
#                               group1 == "1" &
#                               group2 == "2", 1.05, y.position)) %>%
#   mutate(y.position = ifelse(diam_class == "5" &
#                               group1 == "1" &
#                               group2 == "3", 1.15, y.position))
# 
# ### Statistical differences between size classes within successional stages
# 
# stat_test2_p2 <- p2_df %>%
#   group_by(str_class_plots) %>%
#   t_test(agb_prop ~ diam_class) %>%
#   adjust_pvalue(method = "bonferroni") %>%
#   add_significance("p.adj")
# 
# #### Groupings resulted from stat_test2_p2
# 
# c1 <- rep(c(1, 2, 3), each = 6)
# c2 <- rep(seq(1, 6), times = 3)
# c3 <- list(c("a", "b", "b", "bc", "c", "abc",
#        "a", "b", "b", "b", "b", "b",
#        "a", "b", "bc", "bcd", "cd", "e"))
# 
# groupings2 <- data.frame(c1, c2, c3) 
# colnames(groupings2) <- c("str_class_plots", "diam_class", "groupings")
# 
# groupings2 <- groupings2 %>%
#   as_tibble() %>%
#   arrange(diam_class) %>%
#   mutate(succ = ifelse(str_class_plots == "1", "F",
#                        ifelse(str_class_plots == "2", "Y", "M"))) %>%
#   mutate(size_class = ifelse(diam_class == "1", "<10",
#                              ifelse(diam_class == "2", "10-20",
#                                     ifelse(diam_class == "3", "20-30",
#                                            ifelse(diam_class == "4", "30-40",
#                                                   ifelse(diam_class == "5", "40-50", ">50"))))))
# 
# groupings2 <- groupings2 %>%
#   mutate(x_groupings = c(0.7333333, 1.000000, 1.266667, 1.7333333, 2.000000, 2.266667,
#                2.7333333, 3.000000, 3.266667, 3.7333333, 4.000000, 4.266667,
#                4.7333333, 5.000000, 5.266667, 5.7333333, 6.000000, 6.266667))
# 
# groupings2 <- groupings2 %>%
#   as_tibble() %>%
#   mutate(str_class_plots = as.character(str_class_plots),
#          diam_class = as.character(diam_class))
# 
# p2_df <- p2_df %>%
#   left_join(groupings2, by = c("str_class_plots", "diam_class", "succ", "size_class"))

################## With ANOVA and Tukey ###################

### Statistical differences between successional stages within size classes

ap2 <- p2_df %>%
  group_by(diam_class) %>%
  anova_test(agb_prop ~ succ)

tukeyp2 <- p2_df %>%
  group_by(diam_class) %>%
  tukey_hsd(agb_prop ~ str_class_plots)

tukeyp2 <- tukeyp2 %>%
   add_xy_position(x= "diam_class", dodge = 0.8, group = "str_class_plots") %>% 
  # Change y position of statistical differences
  mutate(y.position = ifelse(diam_class == "1" &
                               group1 == "1" &
                               group2 == "3", 1.0, y.position)) %>%
  mutate(y.position = ifelse(diam_class == "2" &
                               group1 == "1" &
                               group2 == "3", 1.1, y.position)) %>%
  mutate(y.position = ifelse(diam_class == "2" &
                               group1 == "2" &
                               group2 == "3", 1.2, y.position)) %>%
  mutate(y.position = ifelse(diam_class == "3" &
                               group1 == "1" &
                               group2 == "3", 1.1, y.position))  %>%
  mutate(y.position = ifelse(diam_class == "3" &
                               group1 == "2" &
                               group2 == "3", 1.2, y.position))  %>%
  mutate(y.position = ifelse(diam_class == "4" &
                               group1 == "1" &
                               group2 == "3", 1.21, y.position))  %>%
  mutate(y.position = ifelse(diam_class == "5" &
                               group1 == "1" &
                               group2 == "3", 1.18, y.position))

### Statistical differences between size classes within successional stages

a2p2 <- p2_df %>%
  group_by(succ) %>%
  anova_test(agb_prop ~ diam_class)

tukey2p2 <- p2_df %>%
  group_by(succ) %>%
  tukey_hsd(agb_prop ~ diam_class)

# Groupings for F forests

tukey2p2_F <- tukey2p2 %>%
  filter(succ == "F") %>%
  select(group1, group2, p.adj.signif) %>%
  unite("comparisons", group1, group2, sep = "-") %>%
  mutate(dif = ifelse(p.adj.signif == "ns", FALSE, TRUE))

difp2_F <- tukey2p2_F$dif
names(difp2_F) <- tukey2p2_F$comparisons
difp2_FL <- multcompLetters(difp2_F)
difp2_FL


# Groupings for Y forests

tukey2p2_y <- tukey2p2 %>%
  filter(succ == "Y") %>%
  select(group1, group2, p.adj.signif) %>%
  unite("comparisons", group1, group2, sep = "-") %>%
  mutate(dif = ifelse(p.adj.signif == "ns", FALSE, TRUE))

dif2y <- tukey2p2_y$dif
names(dif2y) <- tukey2p2_y$comparisons
dif2yL <- multcompLetters(dif2y)
dif2yL


# Groupings for M forests

tukey2p2_m <- tukey2p2 %>%
  filter(succ == "M") %>%
  select(group1, group2, p.adj.signif) %>%
  unite("comparisons", group1, group2, sep = "-") %>%
  mutate(dif = ifelse(p.adj.signif == "ns", FALSE, TRUE))

dif2m <- tukey2p2_m$dif
names(dif2m) <- tukey2p2_y$comparisons
dif2mL <- multcompLetters(dif2m)
dif2mL

#### Groupings resulted from anovas and tukey tests

c1 <- rep(c(1, 2, 3), each = 6)
c2 <- rep(seq(1, 6), times = 3)
c3 <- list(c("a", "b", "b", "bc", "c", "bc",
       "a", "bc", "bc", "b", "bc", "c",
       "a", "b", "b", "bc", "c", "d"))

groupings <- data.frame(c1, c2, c3) 
colnames(groupings) <- c("str_class_plots", "diam_class", "groupings")

groupings <- groupings %>%
  as_tibble() %>%
  arrange(diam_class) %>%
  mutate(succ = ifelse(str_class_plots == "1", "F",
                       ifelse(str_class_plots == "2", "Y", "M"))) %>%
  mutate(size_class = ifelse(diam_class == "1", "<10",
                             ifelse(diam_class == "2", "10-20",
                                    ifelse(diam_class == "3", "20-30",
                                           ifelse(diam_class == "4", "30-40",
                                                  ifelse(diam_class == "5", "40-50", ">50"))))))

groupings <- groupings %>%
  mutate(x_groupings = c(0.7333333, 1.000000, 1.266667, 1.7333333, 2.000000, 2.266667,
               2.7333333, 3.000000, 3.266667, 3.7333333, 4.000000, 4.266667,
               4.7333333, 5.000000, 5.266667, 5.7333333, 6.000000, 6.266667))

groupings <- groupings %>%
  as_tibble() %>%
  mutate(str_class_plots = as.character(str_class_plots),
         diam_class = as.character(diam_class))

p2_df <- p2_df %>%
  left_join(groupings, by = c("str_class_plots", "diam_class", "succ", "size_class"))



## Plot
p2 <-  p2_df %>%
  group_by(str_class_plots, diam_class) %>%
  ggplot(aes(x = factor(size_class, 
                        levels =c("<10", "10-20", "20-30", "30-40", "40-50", ">50"),
                        ordered = TRUE),
             y = agb_prop)) +
  geom_boxplot(aes(fill = factor(succ,
                           levels = c("F","Y", "M"),
                           ordered = TRUE)),
             color = "gray25",
               outlier.alpha = 0.5,
               outlier.color = "gray40",
               outlier.size = 1.5) +
  stat_pvalue_manual(tukeyp2,
                     tip.length = 0.01,
                     hide.ns = T,
                     bracket.size = 0.5,
                     step.increase = 0.001,
                     bracket.nudge.y = -0.015,
                     bracket.shorten = -0.05) +
  geom_text(aes(x= x_groupings,
                y= -0.05,
                label = groupings,
                color = factor(succ,
                           levels = c("F","Y", "M"),
                           ordered = TRUE)),
                size = 3) +
  scale_color_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  scale_fill_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  theme_classic() +
  scale_y_continuous(breaks = c(0.0, 0.25, 0.50, 0.75, 1.0)) +
  labs(x = "Size class",
       y = "Proportion of AGB") +
  theme(axis.title.x = element_text(size = 10)) +
  theme(axis.title.y = element_text(size = 9)) +
  theme(axis.text = element_text(size = 8)) +
  theme(legend.position = "none") +
  theme(plot.margin = margin(b= 10, t= 9))
p1
p2  
   
figure3 <- plot_grid(p1, p2,
                     nrow = 2,
                     ncol = 1,
                     heights = c(1, 1),
                     label_size = 8, labels = c("a)", "b)"))
figure3

####################################################################################################

## Make figure with tukey test groups

# AGB

anova3 <- aov(agb_prop ~ diam_class*succ, data = agb_prop_str)
summary(anova3)
t <- TukeyHSD(anova3)
multcompLetters4(anova3, TukeyHSD(anova3), reversed = T)

#### Groupings resulted from tukey test

c1 <- rep(c(1, 2, 3), each = 6)
c2 <- rep(seq(1, 6), times = 3)
c3 <- list(c("ab", "ef", "def", "efg", "g", "g",
       "a", "cde", "cde", "bcd", "bcde", "defg",
       "a", "ab", "ab", "abc", "bcde", "fg"))

groupings_aov <- data.frame(c1, c2, c3) 
colnames(groupings_aov) <- c("str_class_plots", "diam_class", "groupings")

groupings_aov <- groupings_aov %>%
  as_tibble() %>%
  arrange(diam_class) %>%
  mutate(succ = ifelse(str_class_plots == "1", "F",
                       ifelse(str_class_plots == "2", "Y", "M"))) %>%
  mutate(size_class = ifelse(diam_class == "1", "<10",
                             ifelse(diam_class == "2", "10-20",
                                    ifelse(diam_class == "3", "20-30",
                                           ifelse(diam_class == "4", "30-40",
                                                  ifelse(diam_class == "5", "40-50", ">50"))))))

groupings_aov <- groupings_aov %>%
  mutate(x_groupings = c(0.7333333, 1.000000, 1.266667, 1.7333333, 2.000000, 2.266667,
               2.7333333, 3.000000, 3.266667, 3.7333333, 4.000000, 4.266667,
               4.7333333, 5.000000, 5.266667, 5.7333333, 6.000000, 6.266667))

groupings_aov <- groupings_aov %>%
  as_tibble() %>%
  mutate(str_class_plots = as.character(str_class_plots),
         diam_class = as.character(diam_class))

p2_df <- p2_df %>%
  select(-groupings, -x_groupings)

p2b_df <- p2_df %>%
  left_join(groupings_aov, by = c("str_class_plots", "diam_class", "succ", "size_class"))

p2b <-  p2b_df %>%
  group_by(str_class_plots, diam_class) %>%
  ggplot(aes(x = factor(size_class, 
                        levels =c("<10", "10-20", "20-30", "30-40", "40-50", ">50"),
                        ordered = TRUE),
             y = agb_prop)) +
  geom_boxplot(aes(fill = factor(succ,
                           levels = c("F","Y", "M"),
                           ordered = TRUE)),
             color = "gray25",
               outlier.alpha = 0.5,
               outlier.color = "gray40",
               outlier.size = 1.5) +
  # stat_pvalue_manual(stat_test_p2,
  #                    tip.length = 0.01,
  #                    hide.ns = T,
  #                    bracket.size = 0.5,
  #                    step.increase = 0.001,
  #                    bracket.nudge.y = -0.015,
  #                    bracket.shorten = -0.05) +
  geom_text(aes(x= x_groupings,
                y= -0.05,
                label = groupings),
                # color = factor(succ,
                #            levels = c("F","Y", "M"),
                #            ordered = TRUE)),
                color = "gray40",
            size = 3.5) +
  scale_color_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  scale_fill_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  theme_classic() +
  scale_y_continuous(breaks = c(0.0, 0.25, 0.50, 0.75, 1.0)) +
  labs(x = "Size class",
       y = "Proportion of AGB") +
  theme(axis.title.x = element_text(size = 10)) +
  theme(axis.title.y = element_text(size = 9)) +
  theme(axis.text = element_text(size = 8)) +
  theme(legend.position = "none") +
  theme(plot.margin = margin(b= 10, t= 9))
p2b

# Stem density

anova4 <- aov(stems_prop ~ diam_class*succ, data = stem_prop_str)
summary(anova4)
TukeyHSD(anova4)
multcompLetters4(anova4, TukeyHSD(anova4))

t_stems <- tukey_hsd(anova4)

#### Groupings resulted from tukey test

c1 <- rep(c(1, 2, 3), each = 6)
c2 <- rep(seq(1, 6), times = 3)
c3 <- list(c("a", "a", "bc", "bcd", "bcdef", "bcdef",
       "b", "a", "cde", "f", "f", "ef",
       "bcd", "a", "cdef", "cdef", "def", "def"))

groupings_aov <- data.frame(c1, c2, c3) 
colnames(groupings_aov) <- c("str_class_plots", "diam_class", "groupings")

groupings_aov <- groupings_aov %>%
  as_tibble() %>%
  arrange(diam_class) %>%
  mutate(succ = ifelse(str_class_plots == "1", "F",
                       ifelse(str_class_plots == "2", "Y", "M"))) %>%
  mutate(size_class = ifelse(diam_class == "1", "<10",
                             ifelse(diam_class == "2", "10-20",
                                    ifelse(diam_class == "3", "20-30",
                                           ifelse(diam_class == "4", "30-40",
                                                  ifelse(diam_class == "5", "40-50", ">50"))))))

groupings_aov <- groupings_aov %>%
  mutate(x_groupings = c(0.7333333, 1.000000, 1.266667, 1.7333333, 2.000000, 2.266667,
               2.7333333, 3.000000, 3.266667, 3.7333333, 4.000000, 4.266667,
               4.7333333, 5.000000, 5.266667, 5.7333333, 6.000000, 6.266667))

groupings_aov <- groupings_aov %>%
  as_tibble() %>%
  mutate(str_class_plots = as.character(str_class_plots),
         diam_class = as.character(diam_class))

p1_df <- p1_df %>%
  select(-groupings, -x_groupings)

p1b_df <- p1_df %>%
  left_join(groupings_aov, by = c("str_class_plots", "diam_class", "succ", "size_class"))

p1b <-  p1b_df %>%
  group_by(str_class_plots, diam_class) %>%
  ggplot(aes(x = factor(size_class, 
                        levels =c("<10", "10-20", "20-30", "30-40", "40-50", ">50"),
                        ordered = TRUE),
             y = stem_prop)) +
  geom_boxplot(aes(fill = factor(succ,
                           levels = c("F","Y", "M"),
                           ordered = TRUE)),
             color = "gray25",
               outlier.alpha = 0.5,
               outlier.color = "gray40",
               outlier.size = 1.5) +
  # stat_pvalue_manual(stat_test_p2,
  #                    tip.length = 0.01,
  #                    hide.ns = T,
  #                    bracket.size = 0.5,
  #                    step.increase = 0.001,
  #                    bracket.nudge.y = -0.015,
  #                    bracket.shorten = -0.05) +
  geom_text(aes(x= x_groupings,
                y= -0.05,
                label = groupings),
                # color = factor(succ,
                #            levels = c("F","Y", "M"),
                #            ordered = TRUE)),
                color = "gray40",
            size = 3.5) +
  scale_color_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  scale_fill_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  theme_classic() +
  scale_y_continuous(breaks = c(0.0, 0.25, 0.50, 0.75, 1.0)) +
  labs(x = "Size class",
       y = "Proportion of stems") +
  theme(axis.title.x = element_text(size = 10)) +
  theme(axis.title.y = element_text(size = 9)) +
  theme(axis.text = element_text(size = 8)) +
  theme(legend.position = c(0.9,0.8)) +
  theme(legend.title = element_blank()) +
  theme(plot.margin = margin(b= 10, t= 9))

p1b

figure3b <- plot_grid(p1b, p2b,
                     nrow = 2,
                     ncol = 1,
                     heights = c(1, 1),
                     label_size = 8, labels = c("a)", "b)"))
figure3b

anova3
summary(anova3)
t <- tukey_hsd(anova3)

```

## Figure 4. 

```{r}

fig4_df <- trees_cf_4p %>%
  filter(!is.na(mean_wd)) %>%
  group_by(plot_id) %>%
  summarise(ave_wd = mean(mean_wd),
            sd_wd = sd(mean_wd, na.rm = T),
            se_wd = calcSE(mean_wd),
            max_height = max(height),
            mean_height = mean(height),
            sd_height = sd(height)) %>%
  right_join(plots_cf_4p) %>%
  select(altitude, tree_density, basal_area_ha, loreys_height, mean_height, max_height, ave_wd, se_wd, agb_plot_ha, agb_se_ha, str_class_plots) %>%
  mutate(succ = ifelse(str_class_plots == "1", "F",
                       ifelse(str_class_plots == "2", "Y", "M")))


f4a <- fig4_df %>%
  ggplot(aes(x = tree_density, y = log1p(agb_plot_ha)))  +
  geom_point(aes(color = factor(succ,
                           levels = c("F","Y", "M"),
                           ordered = TRUE)),
             size = 2, alpha = 0.75) +
  scale_color_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  geom_smooth(method = "lm", span=1, color = "gray20", se = F, linetype = "dashed", size = 0.75, alpha= 0.3) +
  #scale_y_continuous(limits = c(0,650)) +
  scale_x_continuous(limits = c(0, 2000)) +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = (bquote('Stem density ('*"tree"~ha^-1*')')),
       y = (bquote('AGB ('*"Mg "~ha^-1*')'))) +
  theme(legend.position = "none")
  # theme(legend.title = element_blank(),
  #       legend.position = c(0.9, 0.8),
  #       legend.background = element_rect(linetype = "solid", size = 0.01, color = "gray50"),
  #       legend.margin = margin(0.1,5,0.1,0.1))

summary(lm(fig4_df$agb_plot_ha ~ log1p(fig4_df$tree_density)))

f4b <- fig4_df %>%
  ggplot(aes(x = basal_area_ha, y = log1p(agb_plot_ha)))  +
  #geom_smooth(method = "loess", span=1, color = "gray20", se = F, linetype = "dashed", size = 0.75, alpha= 0.3) +
  geom_point(aes(color = factor(succ,
                           levels = c("F","Y", "M"),
                           ordered = TRUE)),
             size = 2, alpha = 0.75) +
  scale_color_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  geom_smooth(method = "loess", span=1, color = "gray20", se = F, linetype = "dashed", size = 0.75, alpha= 0.3) +
  #scale_y_continuous(limits = c(0,650)) +
  #scale_x_continuous(limits = c(0, 60)) +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = (bquote('Basal area ('*"m"~ha^-1*')')),
       y = (bquote('AGB ('*"Mg "~ha^-1*')')))

summary(lm(fig4_df$agb_plot_ha ~ log1p(fig4_df$basal_area_ha)))

f4c <- fig4_df %>%
  ggplot(aes(x = loreys_height, y = log1p(agb_plot_ha)))  +
  #geom_smooth(method = "loess", span=1, color = "gray20", se = F, linetype = "dashed", size = 0.75, alpha= 0.3) +
  geom_point(aes(color = factor(succ,
                           levels = c("F","Y", "M"),
                           ordered = TRUE)),
             size = 2, alpha = 0.75) +
  scale_color_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  geom_smooth(method = "loess", span=1, color = "gray20", se = F, linetype = "dashed", size = 0.75, alpha= 0.3) +
  #scale_y_continuous(limits = c(0,650)) +
  #scale_x_continuous(limits = c(0, 40)) +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "Lorey's height (m)",
       y = (bquote('AGB ('*"Mg "~ha^-1*')')))

summary(lm(fig4_df$agb_plot_ha ~ fig4_df$loreys_height))

f4d <- fig4_df %>%
  ggplot(aes(x = mean_height, y = log1p(agb_plot_ha)))  +
  #geom_smooth(method = "loess", span=1, color = "gray20", se = F, linetype = "dashed", size = 0.75, alpha= 0.3) +
  geom_point(aes(color = factor(succ,
                           levels = c("F","Y", "M"),
                           ordered = TRUE)),
             size = 2, alpha = 0.75) +
  scale_color_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  geom_smooth(method = "loess", span=1, color = "gray20", se = F, linetype = "dashed", size = 0.75, alpha= 0.3) +
  #scale_y_continuous(limits = c(0,650)) +
  #scale_x_continuous(limits = c(0, 30)) +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "Average height",
       y = "AGB")

summary(lm(fig4_df$agb_plot_ha ~ fig4_df$mean_height))

f4e <- fig4_df %>%
  ggplot(aes(x = max_height, y = log1p(agb_plot_ha)))  +
  #geom_smooth(method = "loess", span=1, color = "gray20", se = F, linetype = "dashed", size = 0.75, alpha= 0.3) +
  geom_point(aes(color = factor(succ,
                           levels = c("F","Y", "M"),
                           ordered = TRUE)),
             size = 2, alpha = 0.75) +
  scale_color_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  geom_smooth(method = "loess", span=1, color = "gray20", se = F, linetype = "dashed", size = 0.75, alpha= 0.3) +
  #scale_y_continuous(limits = c(0,650)) +
  #scale_x_continuous(limits = c(0, 40)) +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "Max height",
       y = "AGB")

summary(lm(fig4_df$agb_plot_ha ~ fig4_df$max_height))

f4f <- fig4_df %>%
  ggplot(aes(x = ave_wd, y = log1p(agb_plot_ha)))  +
  #geom_smooth(method = "loess", span=1, color = "gray20", se = F, linetype = "dashed", size = 0.75, alpha= 0.3) +
  geom_smooth(method = "loess", span=1, color = "gray20", se = F, linetype = "dashed", size = 0.75, alpha= 0.3) +
  geom_point(aes(color = factor(succ,
                           levels = c("F","Y", "M"),
                           ordered = TRUE)),
             size = 2, alpha = 0.75) +
  scale_color_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  #scale_y_continuous(limits = c(0,650)) +
  #scale_x_continuous(limits = c(0, 1)) +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = (bquote('Wood density ('*"g"~cm^-3*')')),
       y = (bquote('AGB ('*"Mg "~ha^-1*')')))

summary(lm(fig4_df$agb_plot_ha ~ fig4_df$ave_wd))

# figure 4

figure4 <- ggarrange(f4a, f4b, f4c, f4f,
                  ncol = 2,
                  nrow = 2,
                  labels = c("a)", "b)", "c)", "d)"),
                  font.label = list(size= 10),
                  common.legend = F)

figure4
```



## Figure . Relationship between AGB and landscape composition, and diversity and landscape composition

```{r}

# AGB ~ landscape composition

p1 <- sites_cf_4p %>%
  ggplot(aes(x = landscape, y = av_agb_site)) +
  geom_errorbar(aes(ymax = av_agb_site + se_agb_site,
                    ymin = av_agb_site - se_agb_site),
                width = 0.02,
                color = "gray60",
                alpha = 0.8) +
  geom_point(color = "gray60", size = 3, alpha = 0.8) +
  geom_smooth(method = "lm", color = "black", se = F, linetype = "solid", size = 0.75) +
  geom_smooth(method = "loess", span=1, color = "black", se = F, linetype = "dashed", size = 0.75) +
  theme_classic() +
  labs(x = "Land-use intensity",
       y = (bquote('AGB ('*"Mg"~ha^-1*')')))
p1

# Tree diversity ~ landscape composition

p2 <- sites_cf_4p %>%
  ggplot(aes(x = landscape, y = shannon_av_site)) +
  geom_errorbar(aes(ymax = shannon_av_site + shannon_se_site,
                    ymin = shannon_av_site - shannon_se_site),
                width = 0.02,
                color = "gray60",
                alpha = 0.8) +
  geom_smooth(method = "lm", color = "black", se = F, linetype = "solid", size = 0.75) +
  geom_smooth(method = "loess", span=1, color = "black", se = F, linetype = "dashed", size = 0.75) +
  geom_point(color = "gray60", size = 3, alpha = 0.8) +
  theme_classic() +
  labs(x = "Land-use intensity",
       y = "H")

# p3 <- sites_cf_4p %>%
#   ggplot(aes(x = landscape, y = sp_richness_site_av)) +
#   geom_errorbar(aes(ymax = sp_richness_site_av + sp_richness_site_se,
#                     ymin = sp_richness_site_av - sp_richness_site_se),
#                 width = 0.02,
#                 color = "gray60",
#                 alpha = 0.8) +
#   geom_smooth(method = "lm", color = "black", se = F, linetype = "solid", size = 0.75) +
#   geom_smooth(method = "loess", span=1, color = "gray40", se = F, linetype = "dashed") +
#   geom_point(color = "gray60", size = 3, alpha = 0.8) +
#   theme_classic() +
#   labs(x = "Landscape composition",
#        y = "S")
# 
# p2
# p3

figure4 <- plot_grid(p1, p2,
          labels = c("a)", "b)"),
          label_size = 10,
          hjust = -1)

figure4

#summary(lm(shannon_av_site ~ landscape, data = sites_cf_4p))
```

## Figure .  Regressions between AGB and env_pc1 and land-use intensity and env_pc1

```{r}

# AGB ~ env_pc1

p1 <- ggplot(sites_cf_4p, aes(x = env_pc1, y = av_agb_site)) +
  geom_smooth(alpha= 0.1, method = "lm", color = "darkgray", linetype = "dashed") +
  geom_point(aes(color = landscape), size = 4) +
  scale_color_gradient(low = "forestgreen", high =  "lightgoldenrod2") +
  theme_classic() +
  labs(x = "Environmental gradient",
       y = (bquote('AGB ('*"Mg"~ha^-1*')')),
       color = "Land-use \nintensity   ") +
  theme(legend.position='top', 
        legend.justification='right',
        legend.direction='horizontal',
        legend.key.height = unit(0.25, "cm"),
        legend.key.width = unit(0.75, "cm"),
        legend.text = element_text(size= 8),
        legend.title = element_text(size = 9),
        legend.title.align = 0)


# Landscape composition ~ env_pc1

p2 <- ggplot(sites_cf_4p, aes(x = env_pc1, y = landscape)) +
  geom_smooth(alpha= 0.1, method = "lm", color = "darkgray", linetype = "dashed") +
  geom_point(aes(color = av_agb_site), size = 4) +
  scale_color_gradient(high = "darkgreen", low = "darkseagreen1") +
  theme_classic() +
  labs(x = "Environmental gradient",
       y = "Land-use intensity",
       color = (bquote('AGB ('*"Mg"~ha^-1*')'))) +
  scale_y_continuous(limits = c(0.0, 1.0), breaks = c(0.0, 0.25, 0.50, 0.75, 1.00)) +
  theme(legend.position='top', 
        legend.justification='right',
        legend.direction='horizontal',
        legend.key.height = unit(0.25, "cm"),
        legend.key.width = unit(0.75, "cm"),
        legend.text = element_text(size= 8),
        legend.title = element_text(size = 9),
        legend.title.align = 0)

figure5 <- plot_grid(p1, p2,
          labels = c("a)", "b)"),
          label_size = 10,
          hjust = -1)

figure5
```

# Figure . Loess curves of AGB and tree diversity at site and plot levels

```{r}

# Sites

## Shannon

p1 <- sites_cf_4p %>%
  ggplot(aes(x = av_agb_site, y = shannon)) +
  geom_smooth(alpha = 0.1, method = "loess", span = 1, color= "gray75", linetype = "dashed") +
  geom_point(size=2) +
  theme_classic() +
  labs(x = (bquote('AGB ('*"Mg"~ha^-1*')')),
       y = "H")

## Sp richness

p2 <- sites_cf_4p %>%
  ggplot(aes(x = av_agb_site, y = sp_richness_site)) +
  geom_smooth(alpha = 0.1, method = "loess", span = 1, color= "gray75", linetype = "dashed") +
  geom_point(size=2) +
  theme_classic() +
  labs(x = (bquote('AGB ('*"Mg"~ha^-1*')')),
       y= "S")

# Plots

## Shannon 

p3 <- plots_cf_4p %>%
  filter(agb_plot_ha < 600) %>%
  filter(!is.na(shannon)) %>%
  filter(!is.na(agb_plot_ha)) %>%
  group_by(str_class_plots) %>%
  summarise(mean_shannon = mean(shannon),
            mean_agb = mean(agb_plot_ha),
            agb_plot_ha = as.numeric(agb_plot_ha),
            shannon = as.numeric(shannon)) %>%
  mutate(succ = ifelse(str_class_plots == "1", "F",
                       ifelse(str_class_plots == "2", "Y", "M"))) %>%
  ggplot(aes(x = agb_plot_ha, y = shannon)) +
  #geom_point(aes(x= mean_agb, y = mean_shannon, color = factor(succ, levels = c("F","Y", "M"),ordered = TRUE), size = 3)) +
  geom_point(aes(color = factor(succ, levels = c("F","Y", "M"),ordered = TRUE)), size= 2, alpha = 0.75) +
  geom_smooth(alpha = 0.15, method = "loess", span = 1, color= "gray75", linetype = "dashed") +
  theme_classic() +
  scale_color_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  labs(x = (bquote('AGB ('*"Mg"~ha^-1*')')),
       y = "H") +
  theme(legend.position = "none")

## Species richness

p4 <- plots_cf_4p %>%
  filter(agb_plot_ha < 600) %>%
  filter(!is.na(simpson)) %>%
  filter(!is.na(agb_plot_ha)) %>%
  group_by(str_class_plots) %>%
  summarise(mean_sp = mean(sp_richness_plot),
            mean_agb = mean(agb_plot_ha),
            agb_plot_ha = as.numeric(agb_plot_ha),
            sp_richness_plot = as.numeric(sp_richness_plot)) %>%
  mutate(succ = ifelse(str_class_plots == "1", "F",
                       ifelse(str_class_plots == "2", "Y", "M"))) %>%
  ggplot(aes(x = agb_plot_ha,
             y = sp_richness_plot,
             color = factor(succ, levels = c("F","Y", "M"), ordered = TRUE))) +
  geom_point(aes(color = factor(succ, levels = c("F","Y", "M"), ordered = TRUE)), size= 2, alpha = 0.75) +
  geom_smooth(alpha = 0.15, method = "loess", span = 1, color= "gray75", linetype = "dashed") +
  theme_classic() +
  scale_color_manual(values = c("#d95f02", "#7570b3", "#1b9e77")) +
  labs(size = "Average H in successional stage",
       x = (bquote('AGB ('*"Mg"~ha^-1*')')),
       y = "S") +
  theme(legend.title = element_blank(),
        #legend.direction = "horizontal",
        legend.position = c(0.9,0.8),
        legend.background = element_rect(linetype = "solid", size = 0.01, color = "gray50"),
        legend.key.size = unit(0.25, "cm"))

figure6 <- ggarrange(p1,p2,p3,p4,
                  ncol = 2,
                  nrow = 2,
                  labels = c("a)", "b)", "c)", "d)"),
                  font.label = list(size= 10))
figure6
```

# Extra figure: is the relationship between sp diversity and AGB scale dependent?

```{r}

plots_cf_4p %>%
  #filter(agb_plot_ha < 600) %>%
  ggplot(aes(x = shannon, y = log1p(agb_plot_ha))) +
  geom_point(aes(color = str_class_plots)) +
  geom_smooth(method = "lm")

plots_cf_4p %>%
  filter(!str_class_plots == "1") %>%
  ggplot(aes(x = shannon, y = log1p(agb_plot_ha))) +
  geom_point(aes(color = str_class_plots)) +
  geom_smooth(method = "lm")


sites_cf_4p %>%
  ggplot(aes(x = shannon, y = log1p(av_agb_site))) +
  geom_point() +
  geom_smooth(method = "lm")
  
```

# Another extra figure: relationship between all structural attributes and env gradient

```{r}

ggplot(sites_cf_4p, aes(x = env_pc1, y = av_treedensity_site)) +
  geom_smooth(alpha= 0.1, method = "loess", color = "darkgray", linetype = "dashed") +
  geom_point(aes(color = landscape), size = 4) +
  scale_color_gradient(low = "forestgreen", high =  "lightgoldenrod2") +
  labs(y = "Stem density")

ggplot(sites_cf_4p, aes(x = env_pc1, y = av_loreys_site)) +
  geom_smooth(alpha= 0.1, method = "lm", color = "darkgray", linetype = "dashed") +
  geom_point(aes(color = landscape), size = 4) +
  scale_color_gradient(low = "forestgreen", high =  "lightgoldenrod2") +
  labs(y = "Lorey's height")

ggplot(sites_cf_4p, aes(x = env_pc1, y = av_treeheight_site)) +
  geom_smooth(alpha= 0.1, method = "lm", color = "darkgray", linetype = "dashed") +
  geom_point(aes(color = landscape), size = 4) +
  scale_color_gradient(low = "forestgreen", high =  "lightgoldenrod2") +
  labs(y = "Average tree height")

ggplot(sites_cf_4p, aes(x = env_pc1, y = av_basalarea_site)) +
  geom_smooth(alpha= 0.1, method = "lm", color = "darkgray", linetype = "dashed") +
  geom_point(aes(color = landscape), size = 4) +
  scale_color_gradient(low = "forestgreen", high =  "lightgoldenrod2") +
  labs(y = "Basal area")


```

