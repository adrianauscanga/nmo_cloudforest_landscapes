---
title: "05_analysis"
author: "Adriana Uscanga"
date: "14/2/2022"
output: html_document
---

# Analysis

Load packages and files

```{r}
library(tidyverse)
library(ggplot2)
library(rstatix)
```


## 1. Summary statistics and data exploration

Summary statistics

```{r}
summary(sites_cf_4p)
```


Correlations

```{r}
numeric_variables <- sites_cf_4p %>%
  select(temp, precip, altitude, aspect_gee, slope_gee, sp_richness_site_av, shannon_av_site, simpson_av_site, av_agb_site, landscape, agriculture, grazing) %>%
  mutate(log_agb = log(av_agb_site))

corr <- cor(drop_na(numeric_variables[,-1]))
corrplot(corr, method = 'ellipse')
corrplot(corr, method = 'number')
plot(numeric_variables)

plot(numeric_variables$slope_gee, numeric_variables$log_agb)
plot(numeric_variables$agriculture, numeric_variables$log_agb)
plot(numeric_variables$grazing, numeric_variables$log_agb)
plot(numeric_variables$landscape, numeric_variables$log_agb)

plot(numeric_variables$agriculture, numeric_variables$landscape)
plot(numeric_variables$grazing, numeric_variables$landscape)

```


## 2. AGB distribution in TMCF

Tree size classes and contribution to AGB

```{r}

# Estimate total agb per class and plot

agb_class_plots <- trees_cf %>%
  right_join(plots_cf_4p, by = "plot_id") %>%
  filter(status == "Vivo") %>%
  filter(is.na(life_form) | life_form == "Arbol") %>%
  select(plot_id, species, genus, sp, family, diam_bh, agb, str_class_plots) %>%
  mutate(diam_class = ifelse(diam_bh <= 10, "1",
                             ifelse(diam_bh > 10 & diam_bh <= 20, "2",
                                    ifelse(diam_bh > 20 & diam_bh<= 30, "3", 
                                           ifelse(diam_bh > 30 & diam_bh <= 40, "4",
                                                  ifelse(diam_bh > 40 & diam_bh <= 50, "5", "6")))))) %>%
  filter(!is.na(agb)) %>%
  group_by(plot_id, diam_class) %>%
  summarise(agb_class_plot = sum(agb))

agb_class_plots
```

```{r}
# Contribution of tree size to AGB

plots_cf_4p %>%
  select(plot_id, agb_plot) %>%
  right_join(agb_class_plots, by = "plot_id") %>%
  mutate(agb_prop = agb_class_plot/agb_plot)  %>%
  group_by(diam_class) %>%
  get_summary_stats(agb_prop, type = "mean_sd") 

# Plot

plots_cf_4p %>%
  select(plot_id, agb_plot) %>%
  right_join(agb_class_plots, by = "plot_id") %>%
  mutate(agb_prop = agb_class_plot/agb_plot)  %>%
  group_by(diam_class) %>%
  ggplot(aes(x = diam_class, y = agb_prop)) +
  geom_boxplot() +
  theme_classic()

# Anova

agb_prop <- plots_cf_4p %>%
  select(plot_id, agb_plot) %>%
  right_join(agb_class_plots, by = "plot_id") %>%
  mutate(agb_prop = agb_class_plot/agb_plot) %>%
  arrange(diam_class)

pairwise.wilcox.test(x= agb_prop$agb_prop, g= agb_prop$diam_class, p.adjust.method = "bonferroni")

anova <- aov(agb_prop ~ diam_class, data = agb_prop)
TukeyHSD(anova)
  
```

Big trees (size class 6) contributes the most to AGB. Classes 1 and 6 are statistically different from the others.

Tree size classes and contribution to total number of stems:

```{r}
# Contribution of size to stems

stems_class_plot <- trees_cf %>%
  right_join(plots_cf_4p, by = "plot_id") %>%
  filter(status == "Vivo") %>%
  filter(is.na(life_form) | life_form == "Arbol") %>%
  select(plot_id, species, genus, sp, family, diam_bh, agb) %>%
  mutate(diam_class = ifelse(diam_bh <= 10, "1",
                             ifelse(diam_bh > 10 & diam_bh <= 20, "2",
                                    ifelse(diam_bh > 20 & diam_bh<= 30, "3", 
                                           ifelse(diam_bh > 30 & diam_bh <= 40, "4",
                                                  ifelse(diam_bh > 40 & diam_bh <= 50, "5", "6")))))) %>%
  filter(!is.na(agb)) %>%
  group_by(plot_id, diam_class) %>%
  summarise(stems = n())

stems_class_plot
```

Contribution of tree size classes to stem density:

```{r}
plots_cf_4p %>%
  select(plot_id, tree_no) %>%
  right_join(stems_class_plot, by = "plot_id") %>%
  mutate(stem_prop = stems/tree_no)  %>%
  group_by(diam_class) %>%
  get_summary_stats(stem_prop, type = "mean_sd") 

plots_cf_4p %>%
  select(plot_id, tree_no) %>%
  right_join(stems_class_plot, by = "plot_id") %>%
  mutate(stem_prop = stems/tree_no)  %>%
  group_by(diam_class) %>%
  ggplot(aes(x = diam_class, y = stem_prop)) +
  geom_boxplot() +
  theme_classic()

# Anova

stems_prop <- plots_cf_4p %>%
  select(plot_id, tree_no) %>%
  right_join(stems_class_plot, by = "plot_id") %>%
  mutate(stems_prop = stems/tree_no) %>%
  arrange(diam_class)

pairwise.wilcox.test(x= stems_prop$stems_prop, g= stems_prop$diam_class, p.adjust.method = "bonferroni")

anova2 <- aov(stems_prop ~ diam_class, data = stems_prop)
TukeyHSD(anova2)
  
```

Trees of class 2 (20-30 cm of DBH) are the most abundant. All classes are statistically different except for classes 4, 5 and 6.

### Tree size contribution to AGB and stems in relation to successional stage

Contribution to AGB

```{r}

plots_cf_4p %>%
  select(plot_id, agb_plot, str_class_plots) %>%
  right_join(agb_class_plots, by = "plot_id") %>%
  mutate(agb_prop = agb_class_plot/agb_plot)  %>%
  mutate(succ = ifelse(str_class_plots == "1", "vy",
                       ifelse(str_class_plots == "2", "y", "m"))) %>%
  group_by(str_class_plots, diam_class) %>%
  ggplot(aes(x = diam_class, y = agb_prop, fill = factor(succ, levels = c('vy','y', 'm'),ordered = TRUE))) +
  geom_boxplot() +
  theme_classic() +
  labs(fill ='Successional Stage') +
  scale_fill_brewer(palette = "Accent")

plots_cf_4p %>%
  select(plot_id, str_class_plots) %>%
  right_join(agb_prop, by = "plot_id") %>%
  select(-site.x, -site.y) %>%
  group_by(str_class_plots, diam_class) %>%
  get_summary_stats(agb_prop, type = "mean_sd") 

agb_prop_str <- plots_cf_4p %>%
  select(plot_id, str_class_plots) %>%
  right_join(agb_prop, by = "plot_id") %>%
  select(-site.x, -site.y) %>%
  mutate(succ = ifelse(str_class_plots == "1", "vy",
                       ifelse(str_class_plots == "2", "y", "m"))) %>%
  group_by(str_class_plots, diam_class)

anova3 <- aov(agb_prop ~ succ * diam_class, data = agb_prop_str)
summary(anova3)
TukeyHSD(anova3)
```

Contribution to Stem Number

```{r}
plots_cf_4p %>%
  select(plot_id, tree_no, str_class_plots) %>%
  right_join(stems_class_plot, by = "plot_id") %>%
  mutate(stem_prop = stems/tree_no)  %>%
  mutate(succ = ifelse(str_class_plots == "1", "vy",
                       ifelse(str_class_plots == "2", "y", "m"))) %>%
  group_by(str_class_plots, diam_class) %>%
  ggplot(aes(x = diam_class, y = stem_prop, fill = factor(succ, levels = c('vy','y', 'm'),ordered = TRUE))) +
  geom_boxplot() +
  theme_classic() +
  labs(fill ='Successional Stage') +
  scale_fill_brewer(palette = "Accent")

plots_cf_4p %>%
  select(plot_id, str_class_plots) %>%
  right_join(stems_prop, by = "plot_id") %>%
  select(-site.x, -site.y) %>%
  group_by(str_class_plots, diam_class) %>%
  get_summary_stats(stems_prop, type = "mean_sd") 

stem_prop_str <- plots_cf_4p %>%
  select(plot_id, str_class_plots) %>%
  right_join(stems_prop, by = "plot_id") %>%
  select(-site.x, -site.y) %>%
  mutate(succ = ifelse(str_class_plots == "1", "vy",
                       ifelse(str_class_plots == "2", "y", "m"))) %>%
  group_by(str_class_plots, diam_class)

anova4 <- aov(stems_prop ~ succ * diam_class, data = stem_prop_str)
summary(anova4)
TukeyHSD(anova4)
```

### Structural attributes and AGB in three successional stages

```{r}

# Tree density

plots_cf_4p %>%
  mutate(succ = ifelse(str_class_plots == "1", "vy",
                       ifelse(str_class_plots == "2", "y", "m"))) %>%
  group_by(succ) %>%
  get_summary_stats(tree_density, type = "mean_sd")

summary(aov(tree_density ~ str_class_plots, data = plots_cf_4p))
TukeyHSD(aov(tree_density ~ str_class_plots, data = plots_cf_4p))

# Tree height

plots_cf_4p %>%
  mutate(succ = ifelse(str_class_plots == "1", "vy",
                       ifelse(str_class_plots == "2", "y", "m"))) %>%
  group_by(succ) %>%
  get_summary_stats(loreys_height, type = "mean_sd")

summary(aov(loreys_height ~ str_class_plots, data = plots_cf_4p))
TukeyHSD(aov(loreys_height ~ str_class_plots, data = plots_cf_4p))

# Basal area

plots_cf_4p %>%
  mutate(succ = ifelse(str_class_plots == "1", "vy",
                       ifelse(str_class_plots == "2", "y", "m"))) %>%
  group_by(succ) %>%
  get_summary_stats(basal_area_ha, type = "mean_sd")

summary(aov(basal_area_ha ~ str_class_plots, data = plots_cf_4p))
TukeyHSD(aov(basal_area_ha ~ str_class_plots, data = plots_cf_4p))

# AGB

plots_cf_4p %>%
  mutate(succ = ifelse(str_class_plots == "1", "vy",
                       ifelse(str_class_plots == "2", "y", "m"))) %>%
  group_by(succ) %>%
  get_summary_stats(agb_plot_ha, type = "mean_sd")

summary(aov(agb_plot_ha ~ str_class_plots, data = plots_cf_4p))
TukeyHSD(aov(agb_plot_ha ~ str_class_plots, data = plots_cf_4p))
```


## 3. AGB patterns along environmental and land-use gradients

## 4. AGB and tree diversity